name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run test:run -- --coverage
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  wiring:
    name: Wiring & Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx vitest run tests/wiring/ tests/integration/modals.test.js

  i18n-lint:
    name: i18n Key Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: node scripts/lint-i18n.mjs

  rgpd-audit:
    name: RGPD Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: node scripts/audit-rgpd.mjs

  error-registry:
    name: Error Registry Audit
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: node scripts/sentry-to-tests.mjs --audit

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: node scripts/quality-gate.mjs

  build:
    name: Build & Bundle Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - name: Check bundle size
        run: |
          INDEX_SIZE=$(stat -c%s dist/assets/index-*.js 2>/dev/null || echo "0")
          INDEX_KB=$((INDEX_SIZE / 1024))
          echo "Main bundle: ${INDEX_KB}KB"
          if [ "$INDEX_KB" -gt 750 ]; then
            echo "::error::Main bundle exceeds 750KB limit (${INDEX_KB}KB)"
            exit 1
          fi
          echo "Bundle size OK: ${INDEX_KB}KB < 750KB"
      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Download build
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/
      - name: Run Lighthouse CI
        run: npx @lhci/cli autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  e2e-core:
    name: E2E Core (navigation, admin, social, profile)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - name: Download build
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/
      - run: npx playwright test --project=chromium e2e/navigation.spec.js e2e/admin.spec.js e2e/social.spec.js e2e/profile.spec.js e2e/tutorial.spec.js e2e/gamification.spec.js
      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-core-report
          path: playwright-report/

  e2e-features:
    name: E2E Features (critical flows, accessibility, pwa)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - name: Download build
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/
      - run: npx playwright test --project=chromium e2e/criticalFlows.spec.js e2e/accessibility.spec.js e2e/pwa.spec.js
      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-features-report
          path: playwright-report/

  e2e-comprehensive:
    name: E2E Comprehensive (full regression)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - name: Download build
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/
      - run: npx playwright test --project=chromium e2e/comprehensiveE2E.spec.js
      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-comprehensive-report
          path: playwright-report/

  e2e-stress:
    name: E2E Stress (monkey, journeys, visual)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - name: Download build
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/
      - run: npx playwright test --project=chromium e2e/monkeyTest.spec.js e2e/userJourneys.spec.js e2e/map.spec.js
      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-stress-report
          path: playwright-report/

  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [build, test, wiring, lint, quality-gate, e2e-core]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Build with Firebase config
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
      - name: Sanitize commit message
        id: sanitize
        run: |
          MSG=$(git log -1 --pretty=%s | LC_ALL=C tr -cd '[:print:]' | head -c 100)
          echo "msg=${MSG}" >> $GITHUB_OUTPUT
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name spothitch --branch main --commit-message "${{ steps.sanitize.outputs.msg }}"
